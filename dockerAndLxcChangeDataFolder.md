# Как изменить директорию с данными для Docker и LXC

Системы контейнеризации Docker и LXC являются основой для работы Optimacros.

Для более безопасного использования Optimacros, советуем их директории выносить из раздела root (`/`)

## Docker

По умолчанию директория для Docker `/var/lib/docker`
В данной директории хранятся все контейнеры, тома и образы

Для изменения этой директории есть разные варианты, 
больше информации можно получить в интернете, мы взяли по нашему мнению наиболее правильное решение

Наш вариант проверен на Ubuntu 18.04 и ALT Server 9

`! Останавливаем все запущенные контейнеры`

Останавливаем сервис
```
systemctl stop docker
```

Копируем директорию
```
cp -rp /var/lib/docker /opt1/docker
```

Временно архивируем оригинальную директорию
```
mv /var/lib/docker /var/lib/docker.old
```

Открываем файл с глобальными настройками сервиса
```
nano /etc/docker/daemon.json
```

И добавляем к остальным параметрам, параметр `data-root` с значением новой директории
```
{
        "data-root": "/opt1/docker"
}
```

Запускаем сервис
```
systemctl start docker
```

Проверяем результат
```
docker info | grep Root
```

Запускаем нужные существующие контейнеры, если все нормально, можно удалить архивную папку
```
rm -rf /var/lib/docker.old
```

## LXC

По умолчанию директория для LXC `/var/lib/lxc`

В данной директории хранятся все контейнеры

Для изменения этой директории есть разные варианты, больше информации можно получить в интернете, мы взяли по нашему мнению наиболее правильное решение

Наш вариант проверен на Ubuntu 18.04 и ALT Server 9

`! Останавливаем все запущенные контейнеры`

Останавливаем сервис
```
systemctl stop lxc
```

Переносим директорию
```
cp -rp /var/lib/lxc /opt1/lxc
```

Временно архивируем оригинальную директорию
```
mv /var/lib/lxc /var/lib/lxc.old
```

Редктируем файл с конфигурацией, он может отсутствовать, тогда создаем его
```
nano /etc/lxc/lxc.conf
```

Добавляем параметр с новой директорией
```
lxc.lxcpath = /opt1/lxc
```

Запускаем сервис
```
systemctl start lxc
```

`! Для Ubuntu возможно необходима дополнительная настройка (см. ниже)`

Запускаем нужные существующие контейнеры, если все нормально, можно удалить архивную папку
```
rm -rf /var/lib/lxc.old
```

### Ubuntu

При изменении директории LXC возможна ошибка из-за приложения AppArmor

AppArmor - это реализация Модуля безопасности линукс по управлению доступом на основе имен. 
AppArmor ограничивает отдельные программы набором перечисленных файлов и возможностями в соответствии с правилами Posix 1003.1e.

AppArmor сервис может быть не установлен, но LXC будет продолжать ругаться и есть 2 варианта:

#### 1. Установить сервис AppArmor при его отсутствии и отредактировать профиль безопасности (Рекомендуем этот способ)

Отредактируем профиль LXC

```
nano /etc/apparmor.d/abstractions/lxc/start-container
```

Находим строчку `mount -> /var/lib/lxc/{**,},` и меняем ее на нужную нам `mount -> /opt1/lxc/{**,},`

Проверим наличие apparmor утилит

```
which apparmor_parser
which apparmor_status
```

Если результат пустой, то нужно установить пакет `apparmor`

```
apt-get install apparmor
```

После установки, можно проверить текущий статус `apparmor`

```
apparmor_status
```

Скорее всего все показатели будут нулями, так как после установки сервис apparmor не запущен

Запускаем сервис

```
systemctl start apparmor
```

Добавляем его в автозагрузку

```
systemctl enable apparmor
```

Проверяем статус

```
apparmor_status
```

Должна появится информация о загруженных профилях, среди которых есть профили LXC

Если AppArmor был ранее установлен и работал, то после изменений профиля, нужно просто его перезагрузить

```
systemctl restart apparmor
```

#### 2. Добавить в настройки LXC отключение AppArmor

Мы не рекомендуем этот способ, так как он приводит к отключению штатных механизмов безопасности

Данный способ может не сработать при наличии сервиса apparmor

Редактируем файл с конфигурацией LXC

```
nano /etc/lxc/lxc.conf
```

Добавляем в конец файла строчку

```
lxc.apparmor.profile = unconfined
```

Сохраняем файл и проверяем работу LXC
